trigger:
  - bicepazdo

name: Deploy Bicep files

variables:
  vmImageName: 'ubuntu-latest'

  azureServiceConnection: 'scAzureSponsorshipForBicep'
  resourceGroupName: 'exampleRG'
  location: 'westeurope'
  templateFile: './Chapter_07/deployment/main.bicep'
pool:
  vmImage: $(vmImageName)

jobs:
  - job: publishbicep
    displayName: Publish bicep files as pipeline artifacts
    steps:
      #- bash: az bicep build --file ./deployment/main.bicep
      #  displayName: "Transpile Bicep"
      - bash: ls
        displayName: "Lista componentes"

      - task: AzureResourceManagerTemplateDeployment@3
        displayName: Deploy Main Template
        inputs:
          deploymentScope: 'Subscription'
          azureResourceManagerConnection: '$(azureServiceConnection)'
          location: '$(location)'
          templateLocation: 'Linked artifact'
          csmFile: '$(templateFile)'
          csmParametersFile: './Chapter_07/deployment/test.parameters.json'
          deploymentMode: 'Incremental'
          deploymentName: 'DeployPipelineTemplate'
          deploymentOutputs: 'salida'
          
      - task: AzurePowerShell@5
        inputs:
          azureSubscription: 'scAzureSponsorshipForBicep'
          ScriptType: 'InlineScript'
          Inline: |
            $var=ConvertFrom-Json '$(salida)'
            $value=$var.webAppId.value
            Write-Host "##vso[task.setvariable variable=webAppId;]$value"
          FailOnStandardError: true
          azurePowerShellVersion: 'LatestVersion'