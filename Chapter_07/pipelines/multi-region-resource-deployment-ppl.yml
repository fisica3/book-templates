trigger:
  - bicepazdo

variables:
  TestSubscriptionId: "89f21b48-2a5e-477c-ac88-c9cbb8401024"
  TestServiceConnectionName: "scAzureSponsorshipForBicep"

  ProdSubscriptionId: "54a2dff3-7c83-413e-9911-9f21a039e595"
  ProdServiceConnectionName: "scVSSubscriptionForBicep"

  usWebAppId: "webAppId"

stages:
  - stage: build
    displayName: Publish Bicep Files
    jobs:
      - job: publishbicep
        displayName: Publish bicep files as pipeline artifacts
        steps:
          - template: ./templates/transpile-job.yml

  - stage: deployinfratest
    dependsOn: build
    displayName: Deploy to test

    variables:
      environmentName: "test"

    jobs:
      - job: deploy_us_test
        displayName: Deploy infra to US region test
        steps:
          - template: ./templates/deploy-arm.yml
            parameters:
              seriviceConnectionName: ${{ variables.TestServiceConnectionName }}
              subscriptionId: ${{ variables.TestSubscriptionId }}
              location: "westus"
              locationAbbriviation: "us"
              environmentName: ${{ variables.environmentName }}
          - bash: |
              echo "##vso[task.setvariable variable=variables.usWebAppId;]$(webAppId)"              
          - task: Bash@3
            displayName: Output in the same job
            inputs:
              targetType: inline
              script: |
                echo "el Id es = $(variables.usWebAppId)"                

      - job: deploy_eur_test
        displayName: Deploy infra to EUR region test
        dependsOn: deploy_us_test
        steps:
          - template: ./templates/deploy-arm.yml
            parameters:
              seriviceConnectionName: ${{ variables.TestServiceConnectionName }}
              subscriptionId: ${{ variables.TestSubscriptionId }}
              location: "westeurope"
              locationAbbriviation: "we"
              environmentName: ${{ variables.environmentName }}

